---
- hosts: all
  gather_facts: false
  tasks:
    - name: Build compose definition
      ansible.builtin.set_fact:
        compose_definition:
          services:
            tcp:
              image: "{{ image }}"
              environment: "{{ env | default({}) }}"
              network_mode: bridge
              ports: "{{ published_ports }}"
              restart: unless-stopped
          networks: "{{ {traefik_network: {'external': true}} }}"
      tags:
        - create
        - delete

    - name: Déploiement du docker-compose
      community.docker.docker_compose_v2:
        definition: "{{ compose_definition }}"
        project_name: "{{ compose_project }}"
        pull: always
      tags: create

    - name: Arrêt et suppression du docker-compose
      community.docker.docker_compose_v2:
        definition: "{{ compose_definition }}"
        project_name: "{{ compose_project }}"
        state: absent
      tags: delete