openapi: 3.0.3
info:
  title: Galvanize Instancer
  version: 0.5.5
  description: API for deploying CTF challenges using Ansible

paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      security: [ ]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  # For reference only. Commented since oapi-codegen would overwrite the handler we expose ourselves
  #  /metrics:
  #    get:
  #      summary: Prometheus metrics
  #      operationId: getMetrics
  #      security: []
  #      responses:
  #        '200':
  #          description: Prometheus metrics
  #          content:
  #            text/plain:
  #              schema:
  #                type: string

  /deploy:
    post:
      summary: Deploy a challenge instance
      operationId: deployInstance
      security:
        - bearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
      responses:
        '202':
          description: Deployment request accepted
        '400':
          description: Invalid Request / Unknown Challenge ID
        '401':
          description: Unauthorized
        '409':
          description: Deployment already in progress/complete
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /terminate:
    post:
      summary: Terminate a challenge instance
      operationId: terminateInstance
      security:
        - bearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
      responses:
        '200':
          description: Termination successful
        '401':
          description: Unauthorized
        '500':
          description: Internal server error

  /status:
    get:
      summary: Get deployment status
      operationId: getInstanceStatus
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: Status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '401':
          description: Unauthorized
        '404':
          description: No deployment
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /extend:
    post:
      summary: Extend the duration of a deployment
      operationId: extendInstance
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: Duration extended successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Cannot extend deployment (too early, max extensions reached, etc.)
        '401':
          description: Unauthorized
        '404':
          description: No deployment
        '500':
          description: Internal server error

  /admin/deploy:
    post:
      summary: Deploy a unique challenge (admin only)
      operationId: deployAdminInstance
      security:
        - bearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminDeployRequest'
      responses:
        '202':
          description: Deployment request accepted
        '400':
          description: Invalid Request / Unknown Challenge ID
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '409':
          description: Deployment already exists
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/terminate:
    post:
      summary: Terminate a unique challenge (admin only)
      operationId: terminateAdminInstance
      security:
        - bearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminDeployRequest'
      responses:
        '200':
          description: Termination successful
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '404':
          description: No deployment found
        '500':
          description: Internal server error

  /admin/deploy-all:
    post:
      summary: Deploy all unique challenges (admin only)
      operationId: deployAllAdminInstances
      security:
        - bearerAuth: [ ]
      responses:
        '202':
          description: Bulk deployment started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkOperationResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error

  /admin/terminate-all:
    post:
      summary: Terminate all unique challenges (admin only)
      operationId: terminateAllAdminInstances
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: Bulk termination started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkOperationResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error

  /admin/list-unique-challs:
    get:
      summary: List all unique challenges
      operationId: listUniqueChallenges
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: List of unique challenges
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChallengeCategoryResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error

  /admin/config-check:
    post:
      summary: Check communication with Zync
      operationId: configCheck
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: Communication with Zync successful
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error

  /admin/reload-challs:
    post:
      summary: Reload challenges index
      description: Reload challenges index from disk and update the inmemory index
      operationId: reloadChallenges
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: Reload successful
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error

  /admin/team-deployments:
    get:
      summary: List all deployments grouped by team (admin only)
      description: Get all deployments with status starting, running or stopping, grouped by team with deployment duration
      operationId: listTeamDeployments
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: List of deployments per team
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TeamDeploymentsResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/error-deployments:
    get:
      summary: List all deployments in error status (admin only)
      description: Get all deployments with status error, including error messages
      operationId: listErrorDeployments
      security:
        - bearerAuth: [ ]
      responses:
        '200':
          description: List of error deployments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorDeploymentInfo'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/retry-deployment:
    post:
      summary: Retry a failed deployment (admin only)
      description: Retry a deployment that is in error status. Specify action as 'deploy' or 'terminate'.
      operationId: retryDeployment
      security:
        - bearerAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetryDeploymentRequest'
      responses:
        '202':
          description: Retry request accepted
        '400':
          description: Invalid request or deployment not in error status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - Admin access required
        '404':
          description: Deployment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    DeployRequest:
      type: object
      required:
        - category
        - challenge_name
      properties:
        category:
          type: string
          description: The category of the challenge to deploy.
        challenge_name:
          type: string
          description: The name of the challenge to deploy.

    StatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ running, stopping, starting, error ]
        connection_info:
          type: string
        expiration_time:
          type: string
          format: date-time
        extensions_left:
          type: integer
          description: Number of extensions left for this deployment. -1 if unlimited.
        extension_time:
          description: Time duration each extension adds (e.g., "30m", "1h").
          type: string
        unique:
          description: Whether this is a unique deployment or not.
          type: boolean


    Error:
      type: object
      properties:
        message:
          type: string

    AdminDeployRequest:
      type: object
      required:
        - category
        - challenge_name
      properties:
        category:
          type: string
          description: The category of the challenge to deploy.
        challenge_name:
          type: string
          description: The name of the challenge to deploy.

    AdminStatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ running, stopping, starting, error ]
        connection_info:
          type: string

    BulkOperationResponse:
      type: object
      properties:
        message:
          type: string
        challenges_count:
          type: integer
        challenges:
          type: array
          items:
            $ref: '#/components/schemas/ChallengeCategoryResponse'
      required:
        - message
        - challenges_count
        - challenges

    ChallengeCategoryResponse:
      type: object
      properties:
        category:
          type: string
        challenge_name:
          type: string
      required:
        - category
        - challenge_name

    TeamDeploymentsResponse:
      type: object
      properties:
        team_id:
          type: string
          description: The team identifier. Empty string for unique/admin deployments.
        deployments:
          type: array
          items:
            $ref: '#/components/schemas/DeploymentInfo'
      required:
        - team_id
        - deployments

    DeploymentInfo:
      type: object
      properties:
        category:
          type: string
        challenge_name:
          type: string
        status:
          type: string
          enum: [ starting, running, stopping ]
        deployed_since:
          type: string
          format: date-time
          description: The time the deployment was created.
        deployed_duration_seconds:
          type: integer
          description: Duration in seconds since deployment started.
        connection_info:
          type: string
        expires_at:
          type: string
          format: date-time
          description: When the deployment expires. Null for unique deployments.
      required:
        - category
        - challenge_name
        - status
        - deployed_since
        - deployed_duration_seconds

    ErrorDeploymentInfo:
      type: object
      properties:
        id:
          type: integer
          description: The deployment ID.
        category:
          type: string
        challenge_name:
          type: string
        team_id:
          type: string
          description: The team identifier. Empty string for unique/admin deployments.
        previous_status:
          type: string
          enum: [ starting, stopping ]
          description: The status before the deployment transitioned to error. Indicates whether a deploy or terminate action was in progress.
        error_message:
          type: string
          description: The error message from the failed deployment.
        created_at:
          type: string
          format: date-time
          description: When the deployment was created.
        updated_at:
          type: string
          format: date-time
          description: When the deployment was last updated.
      required:
        - id
        - category
        - challenge_name
        - team_id
        - previous_status
        - error_message
        - created_at
        - updated_at

    RetryDeploymentRequest:
      type: object
      required:
        - deployment_id
      properties:
        deployment_id:
          type: integer
          description: The ID of the deployment to retry.
        action:
          type: string
          enum: [ deploy, terminate, delete ]
          description: The action to perform - 'deploy' to retry deployment, 'terminate' to terminate the failed deployment, 'delete' to remove the deployment from the database. If not provided, the action will be inferred from the previous status (deploy or terminate only).
